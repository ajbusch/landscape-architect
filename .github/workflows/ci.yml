name: CI

on:
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.head_ref }}
  cancel-in-progress: true

permissions:
  contents: read
  pull-requests: write

jobs:
  quality:
    name: Lint & Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm typecheck

      - name: Format check
        run: pnpm format:check

  test-unit:
    name: Unit & Contract Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Unit tests
        run: pnpm test:unit

      - name: Contract tests
        run: pnpm test:contract

  test-integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: testdb
        ports: ['5432:5432']
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Integration tests
        run: pnpm test:integration
        env:
          DATABASE_URL: postgres://test:test@localhost:5432/testdb

  security:
    name: Security
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Security audit
        run: pnpm audit --audit-level=high

      - name: Secret detection
        run: pnpm lint:secrets

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [quality, test-unit, security]
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/setup

      - name: Build all packages
        run: pnpm build
